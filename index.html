<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>數字中翻英練習</title>
</head>
<body>
  <h1>數字中翻英練習</h1>
  <button onclick="playAudio()">🔊 播放英文語音</button>
  <button id="speechBtn" onclick="startSpeechRecognition()">🎤 語音輸入</button>
  <button id="stopBtn" onclick="stopSpeechRecognition()" style="display:none;">🛑 停止錄音</button>
  <p id="speechOutput"></p>
  <audio id="userRecording" controls style="display:none;"></audio>
  <a id="downloadLink" style="display:none;" download="recording.webm">⬇️ 下載你的發音錄音</a>

  <script>
let naturalVoice = null;
speechSynthesis.onvoiceschanged = () => {
  const voices = speechSynthesis.getVoices();
  naturalVoice = voices.find(v => /Google UK English Female|Microsoft Aria|en-US/i.test(v.name)) || voices[0];
};

function playAudio() {
  const utter = new SpeechSynthesisUtterance("three million sixty-five thousand two hundred seventy-eight");
  if (naturalVoice) utter.voice = naturalVoice;
  speechSynthesis.speak(utter);
}

let recognition = null, mediaRecorder = null;

function stopSpeechRecognition() {
  if (recognition) recognition.abort();
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  document.getElementById('speechOutput').textContent = "⏹️ 已停止錄音";
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('speechBtn').disabled = false;
}

function startSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("你的瀏覽器不支援語音辨識。");
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  const output = document.getElementById('speechOutput');
  const btn = document.getElementById('speechBtn');
  output.classList.add('listening');
  output.textContent = "🎙️ 正在聆聽...";
  btn.disabled = true;
  document.getElementById('stopBtn').style.display = 'inline-block';

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = document.getElementById('userRecording');
      audio.src = audioUrl;
      audio.style.display = 'block';
      const download = document.getElementById('downloadLink');
      download.href = audioUrl;
      download.style.display = 'inline';
      download.download = `recording_${Date.now()}.webm`;
    };
    mediaRecorder.start();
    setTimeout(() => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    }, 10000); // default 10s
    recognition.start();
  });

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    output.textContent = `你說的是：「${transcript}」`;
  };

  recognition.onerror = function(event) {
    output.textContent = "❌ 語音辨識錯誤: " + event.error;
  };

  recognition.onend = function() {
    output.classList.remove('listening');
    btn.disabled = false;
    document.getElementById('stopBtn').style.display = 'none';
  };
}
  </script>
</body>
</html>
